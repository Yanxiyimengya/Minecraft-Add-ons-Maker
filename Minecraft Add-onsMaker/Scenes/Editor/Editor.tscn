[gd_scene load_steps=24 format=3 uid="uid://da4h7gw2hkkq3"]

[ext_resource type="Theme" uid="uid://c3gb35qykvkhd" path="res://Assets/Theme/EditorGUI.tres" id="1_cb2ps"]
[ext_resource type="Script" path="res://addons/dockable_container/dockable_container.gd" id="2_e41y2"]
[ext_resource type="Script" path="res://addons/dockable_container/layout_panel.gd" id="3_0yuwg"]
[ext_resource type="Script" path="res://addons/dockable_container/layout_split.gd" id="4_pdwge"]
[ext_resource type="Script" path="res://addons/dockable_container/layout.gd" id="5_bsi6d"]
[ext_resource type="PackedScene" uid="uid://bduidxqriia4b" path="res://Scenes/Editor/EditorPanel/FileSystem.tscn" id="6_ud30c"]
[ext_resource type="StyleBox" uid="uid://uxe2elr0vaut" path="res://Assets/Theme/Styles/EditorPanel/EditorTitlePanel.tres" id="7_uw54b"]

[sub_resource type="GDScript" id="GDScript_p57vs"]
script/source = "extends Panel;
@onready var file_system := %FileSystem;
@onready var asset_manager := %AssetSystem;

@onready var attribute_editor := %AttributeEditor;

func _ready() : 
	get_window().mode = Window.MODE_MAXIMIZED;
	get_window().files_dropped.connect(_window_files_dropped);
	
	file_system.reload_resource_tree();
	file_system.res_tree.checked_data.connect( func(data : ResourceManager.ResourceData) : 
		if (data.data is MinecraftTextureResource) : 
			attribute_editor.update_edit(data);
	);
	
	if (!ProjectManager.current_project_config.is_data_pack) : 
		%EditorDockable.layout.hidden_tabs[\"AssetSystem\"] = true;
	if (!ProjectManager.current_project_config.is_resource_pack) : 
		%EditorDockable.layout.hidden_tabs[\"FileSystem\"] = true;
	

func _window_files_dropped(files : PackedStringArray) : 
	if (files.size() > 0) : 
		var target_item : TreeItem = file_system.res_tree.get_selected();
		if (target_item == null) : 
			target_item = file_system.res_tree.get_root();
		for filep : String in files : 
			var res_path : String = ProjectManager.current_project_config.project_path + \"/res\";
			var file_name : String = filep.get_file();
			if (!target_item.get_metadata(0).get_metadata(0).is_folder) : 
				target_item = target_item.get_parent();
				# 判断要放置项的类型
			var f_path : String = target_item.get_metadata(0).get_metadata(0).path;
			FileTools.copy_dir(filep, res_path + \"/\" + f_path + \"/\" + file_name);
			if (DirAccess.dir_exists_absolute(filep)) : 
				var root : TreeItem = ResourceManager.create_folder(filep.get_file(), target_item.get_metadata(0));
				if (root != null) : 
					ResourceManager.load_files(filep, root);
				continue;
			ResourceManager.load_resource_to_apped(filep, target_item.get_metadata(0));
"

[sub_resource type="Theme" id="Theme_xcvyb"]
HSplitContainer/constants/separation = 6
VSplitContainer/constants/separation = 6

[sub_resource type="Resource" id="Resource_krvj5"]
resource_name = "Tabs"
script = ExtResource("3_0yuwg")
names = PackedStringArray("AssetSystem")
current_tab = 0

[sub_resource type="Resource" id="Resource_5rgto"]
resource_name = "Tabs"
script = ExtResource("3_0yuwg")
names = PackedStringArray("FileSystem")
current_tab = 0

[sub_resource type="Resource" id="Resource_ol7cv"]
resource_name = "Split"
script = ExtResource("4_pdwge")
direction = 1
percent = 0.5
first = SubResource("Resource_krvj5")
second = SubResource("Resource_5rgto")

[sub_resource type="Resource" id="Resource_n6fy5"]
resource_name = "Tabs"
script = ExtResource("3_0yuwg")
names = PackedStringArray("View")
current_tab = 0

[sub_resource type="Resource" id="Resource_tl6k6"]
resource_name = "Tabs"
script = ExtResource("3_0yuwg")
names = PackedStringArray("Bottom")
current_tab = 0

[sub_resource type="Resource" id="Resource_pxuey"]
resource_name = "Split"
script = ExtResource("4_pdwge")
direction = 1
percent = 0.785156
first = SubResource("Resource_n6fy5")
second = SubResource("Resource_tl6k6")

[sub_resource type="Resource" id="Resource_qtgxs"]
resource_name = "Tabs"
script = ExtResource("3_0yuwg")
names = PackedStringArray("AttributeEditor")
current_tab = 0

[sub_resource type="Resource" id="Resource_tjx7x"]
resource_name = "Split"
script = ExtResource("4_pdwge")
direction = 0
percent = 0.780647
first = SubResource("Resource_pxuey")
second = SubResource("Resource_qtgxs")

[sub_resource type="Resource" id="Resource_n1b0a"]
resource_name = "Split"
script = ExtResource("4_pdwge")
direction = 0
percent = 0.179245
first = SubResource("Resource_ol7cv")
second = SubResource("Resource_tjx7x")

[sub_resource type="Resource" id="Resource_n6v1n"]
resource_name = "Layout"
script = ExtResource("5_bsi6d")
root = SubResource("Resource_n1b0a")
hidden_tabs = {
"AssetSystem": false,
"FileSystem": false
}

[sub_resource type="GDScript" id="GDScript_kk7ij"]
script/source = "extends VBoxContainer;


func _on_button_pressed():
	Global.cmd([\"ExportProject\", \"C:/Users/guosh/Desktop/Test.mcaddon\"]);
"

[sub_resource type="GDScript" id="GDScript_pm6k7"]
script/source = "extends Container;
@onready var attribute_container = $AttributeContainer;

func _ready() : 
	register_edit(MinecraftTextureResource, preload(\"res://Scenes/Editor/AttributeEditor/Edit/TextureEdit/TextureEdit.tscn\"));


var currect_edit : Node = null;
func update_edit(_target : Variant) : 
	open_edit(_target.data);
	if (currect_edit != null) : 
		currect_edit.target = _target;
		if (currect_edit.has_method(\"_set_target\")) : 
			currect_edit.call(\"_set_target\");

var editor_map : Dictionary = {};
func register_edit(type : Variant, editor_scene : PackedScene) : 
	if (editor_map.has(type) || editor_scene == null) : 
		return;
	var scene_inst : Node = editor_scene.instantiate();
	attribute_container.add_child(scene_inst);
	scene_inst.set_process(false);
	scene_inst.visible = false;
	editor_map[type] = scene_inst;
	attribute_container.queue_sort();

func open_edit(target : Variant) : 
	if (target == null) :
		return;
	if (currect_edit != null) : 
		currect_edit.visible = false;
		currect_edit.set_process(false);
	var previous_edit : Node = currect_edit;
	
	if (target is MinecraftTextureResource) : 
		currect_edit = editor_map[MinecraftTextureResource];
	
	currect_edit.visible = true;
	currect_edit.set_process(true);
"

[sub_resource type="GDScript" id="GDScript_3bupa"]
script/source = "extends Container;

@onready var asset_tree : Tree = %AssetTree;

func _ready() : 
	var res_root : TreeItem = asset_tree.create_item();
	res_root.set_text(0, \"附加包资产\");

func create_folder(folder_name : String, parent : TreeItem) -> TreeItem : 
	var item : TreeItem = AssetManager.append_folder_to_tree(folder_name, parent.get_metadata(0))
	if (parent == null || item == null) : 
		return;
	var folder_item : TreeItem = parent.create_child();
	folder_item.set_text(0, folder_name);
	folder_item.set_metadata(0, item);
	return folder_item;
	# 创建一个目录文件

func get_valid_asset_name(tree_item : TreeItem, asset_name : String) -> String : 
	var result_name : String = asset_name;
	var count : int = 2;
	var exists : bool = false;
	while(true) : 
		exists = false;
		for item in tree_item.get_children() : 
			if (item.get_text(0) == tree_item.get_text(0)) : 
				exists = true;
				result_name = asset_name + str(count);
				count += 1;
				break;
		if (!exists) : 
			break;
	return result_name;
	# 如果在以一个item下面创建文件,获取有效的文件名

func _on_add_asset_button_pressed() : 
	var root : TreeItem = asset_tree.get_root();
	if (root == null) : 
		return;
	var select_item : TreeItem = asset_tree.get_selected();
	if (select_item == null) : 
		select_item = root;
	
	# 添加一个资产

func _on_asset_tree_item_activated() : 
	var tree_item : TreeItem = asset_tree.get_selected();
	if (asset_tree.get_root() == tree_item) : 
		return;
	var target = tree_item.get_metadata(0).get_metadata(0).data;
	%AttributeEditor.update_edit(target);
	# 在树中双击
"

[sub_resource type="StyleBoxEmpty" id="StyleBoxEmpty_3ftkk"]

[node name="Editor" type="Panel"]
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
theme = ExtResource("1_cb2ps")
script = SubResource("GDScript_p57vs")

[node name="EditorDockable" type="Container" parent="."]
unique_name_in_owner = true
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
theme = SubResource("Theme_xcvyb")
script = ExtResource("2_e41y2")
tabs_visible = false
layout = SubResource("Resource_n6v1n")

[node name="FileSystem" parent="EditorDockable" instance=ExtResource("6_ud30c")]
unique_name_in_owner = true
custom_minimum_size = Vector2(0, 0)
layout_mode = 2
size_flags_horizontal = 0
size_flags_vertical = 4
theme_override_styles/panel = ExtResource("7_uw54b")

[node name="View" type="VBoxContainer" parent="EditorDockable"]
custom_minimum_size = Vector2(540, 360)
layout_mode = 2
size_flags_horizontal = 3
size_flags_vertical = 3
script = SubResource("GDScript_kk7ij")

[node name="PanelContainer" type="PanelContainer" parent="EditorDockable/View"]
layout_mode = 2
size_flags_vertical = 0

[node name="HBoxContainer" type="HBoxContainer" parent="EditorDockable/View/PanelContainer"]
layout_mode = 2

[node name="Button" type="Button" parent="EditorDockable/View/PanelContainer/HBoxContainer"]
layout_mode = 2
text = "导出"

[node name="SubViewportContainer" type="SubViewportContainer" parent="EditorDockable/View"]
layout_mode = 2
size_flags_vertical = 3
stretch = true

[node name="SubViewport" type="SubViewport" parent="EditorDockable/View/SubViewportContainer"]
handle_input_locally = false
size = Vector2i(2, 2)
render_target_update_mode = 4

[node name="AttributeEditor" type="PanelContainer" parent="EditorDockable"]
unique_name_in_owner = true
custom_minimum_size = Vector2(140, 0)
layout_mode = 2
theme_override_styles/panel = ExtResource("7_uw54b")
script = SubResource("GDScript_pm6k7")

[node name="AttributeContainer" type="VBoxContainer" parent="EditorDockable/AttributeEditor"]
layout_mode = 2

[node name="Panel" type="Panel" parent="EditorDockable/AttributeEditor/AttributeContainer"]
custom_minimum_size = Vector2(0, 30)
layout_mode = 2

[node name="AssetSystem" type="PanelContainer" parent="EditorDockable"]
unique_name_in_owner = true
custom_minimum_size = Vector2(150, 0)
layout_mode = 2
theme_override_styles/panel = ExtResource("7_uw54b")
script = SubResource("GDScript_3bupa")

[node name="VBoxContainer" type="VBoxContainer" parent="EditorDockable/AssetSystem"]
layout_mode = 2

[node name="MarginContainer" type="MarginContainer" parent="EditorDockable/AssetSystem/VBoxContainer"]
layout_mode = 2
theme_override_constants/margin_left = 5
theme_override_constants/margin_top = 5
theme_override_constants/margin_right = 5
theme_override_constants/margin_bottom = 5

[node name="HBoxContainer" type="HBoxContainer" parent="EditorDockable/AssetSystem/VBoxContainer/MarginContainer"]
layout_mode = 2
size_flags_vertical = 0

[node name="AddAssetButton" type="Button" parent="EditorDockable/AssetSystem/VBoxContainer/MarginContainer/HBoxContainer"]
layout_mode = 2
text = "添加"

[node name="LineEdit" type="LineEdit" parent="EditorDockable/AssetSystem/VBoxContainer/MarginContainer/HBoxContainer"]
layout_mode = 2
size_flags_horizontal = 3

[node name="AssetTree" type="Tree" parent="EditorDockable/AssetSystem/VBoxContainer"]
unique_name_in_owner = true
layout_mode = 2
size_flags_vertical = 3
theme_override_styles/panel = SubResource("StyleBoxEmpty_3ftkk")
scroll_horizontal_enabled = false

[node name="Bottom" type="Panel" parent="EditorDockable"]
custom_minimum_size = Vector2(0, 130)
layout_mode = 2
theme_override_styles/panel = ExtResource("7_uw54b")

[connection signal="pressed" from="EditorDockable/View/PanelContainer/HBoxContainer/Button" to="EditorDockable/View" method="_on_button_pressed"]
[connection signal="pressed" from="EditorDockable/AssetSystem/VBoxContainer/MarginContainer/HBoxContainer/AddAssetButton" to="EditorDockable/AssetSystem" method="_on_add_asset_button_pressed"]
[connection signal="item_activated" from="EditorDockable/AssetSystem/VBoxContainer/AssetTree" to="EditorDockable/AssetSystem" method="_on_asset_tree_item_activated"]
